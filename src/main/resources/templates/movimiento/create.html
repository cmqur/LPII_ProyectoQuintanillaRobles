<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head('Nuevo Movimiento')"></head>
<body>
<div th:replace="fragments/navbar :: navbar"></div>

<div class="container py-4" data-movement-form>
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h3 class="page-title mb-1">Nuevo movimiento</h3>
      <div class="text-secondary">Registra un ingreso, salida o transferencia de stock</div>
    </div>
    <a class="btn btn-outline-dark" th:href="@{/movimiento}"><i class="bi bi-arrow-left me-1"></i>Volver</a>
  </div>

  <!-- Alertas flash (mensaje/clase) -->
  <div th:if="${mensaje != null}" class="alert" role="alert"
       th:classappend="' alert-' + (${clase != null} ? ${clase} : 'info')"
       th:text="${mensaje}"></div>

  <div class="row g-3">
    <div class="col-12 col-lg-5">
      <div class="card shadow-soft">
        <div class="card-body">
          <h5 class="mb-3">Datos del movimiento</h5>

          <form th:action="@{/movimiento/terminar}" method="post" th:object="${movimiento}" id="formMovimiento">
            <div class="mb-3">
              <label class="form-label">Tipo</label>
              <select class="form-select" th:field="*{tipo}" id="tipoMovimiento" required>
                <option value="" selected disabled>Seleccione…</option>
                <option value="INGRESO">Ingreso</option>
                <option value="SALIDA">Salida</option>
                <option value="TRANSFERENCIA">Transferencia</option>
              </select>
              <div class="form-text">Consejo: usa <b>Transferencia</b> para mover stock entre almacenes.</div>
            </div>

            <div class="mb-3" data-only="origen">
              <label class="form-label">Almacén origen</label>
              <select class="form-select" th:field="*{almacenOrigen}" id="almacenOrigen">
                <option value="" selected>—</option>
                <option th:each="a : ${almacenList}" th:value="${a.id}" th:text="${a.nombre}"></option>
              </select>
            </div>

            <div class="mb-3" data-only="destino">
              <label class="form-label">Almacén destino</label>
              <select class="form-select" th:field="*{almacenDestino}" id="almacenDestino">
                <option value="" selected>—</option>
                <option th:each="a : ${almacenList}" th:value="${a.id}" th:text="${a.nombre}"></option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Usuario responsable</label>
              <select class="form-select" name="idUsuario" id="idUsuario">
                <option value="" selected>—</option>
                <option th:each="u : ${usuarioList}" th:value="${u.id}" th:text="${u.nombres}"></option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Observación</label>
              <textarea class="form-control" th:field="*{observacion}" rows="2" placeholder="Ej: Ajuste de inventario / recepción de mercadería"></textarea>
            </div>

            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-success" th:disabled="${totalItems == 0}">
                <i class="bi bi-check-circle me-1"></i>Finalizar
              </button>
              <a class="btn btn-outline-secondary" th:href="@{/movimiento/limpiar}">
                <i class="bi bi-arrow-clockwise me-1"></i>Limpiar carrito
              </a>
            </div>

            <div class="mt-3 small text-secondary">
              Items agregados: <b th:text="${totalItems}">0</b>
            </div>
          </form>
        </div>
      </div>

      <div class="card shadow-soft mt-3">
        <div class="card-body">
          <h6 class="mb-2">Accesos rápidos</h6>
          <div class="d-flex flex-wrap gap-2">
            <a class="btn btn-outline-dark btn-sm" th:href="@{/producto}"><i class="bi bi-tags me-1"></i>Productos</a>
            <a class="btn btn-outline-dark btn-sm" th:href="@{/almacen}"><i class="bi bi-building me-1"></i>Almacenes</a>
            <a class="btn btn-outline-dark btn-sm" th:href="@{/reportes/stockminimo(modo='ver')}" target="_blank"><i class="bi bi-exclamation-triangle me-1"></i>Stock mínimo</a>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-7">
      <div class="card shadow-soft">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h5 class="mb-0">Productos del movimiento</h5>
            <span class="badge text-bg-light border">Carrito</span>
          </div>
          <div class="text-secondary mb-3">Agrega productos por código. Puedes sumar cantidades.</div>

          <form th:object="${producto}" th:action="@{/movimiento/agregar}" method="post" class="row g-2 align-items-end">
            <div class="col-12 col-md-7">
              <label class="form-label">Código del producto</label>
              <input class="form-control" th:field="*{codigo}" placeholder="Ej: P-0001" autocomplete="off" autofocus>
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label">Cantidad</label>
              <input class="form-control" name="cantidad" type="number" min="1" value="1">
            </div>
            <div class="col-12 col-md-2">
              <button class="btn btn-primary w-100" type="submit">
                <i class="bi bi-plus-lg"></i>
              </button>
            </div>
          </form>

          <hr class="my-3">

          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead>
              <tr>
                <th>Producto</th>
                <th>Código</th>
                <th class="text-end">Cantidad</th>
                <th class="text-end">Quitar</th>
              </tr>
              </thead>
              <tbody>
              <tr th:each="p, iter : ${session.carritoMovimiento}">
                <td>
                  <div class="fw-semibold" th:text="${p.descripcion}"></div>
                  <div class="small text-secondary">Stock global: <span th:text="${p.stock}"></span></div>
                </td>
                <td th:text="${p.codigo}"></td>
                <td class="text-end"><span class="badge text-bg-primary" th:text="${p.cantidad}"></span></td>
                <td class="text-end">
                  <form th:action="@{/movimiento/quitar/{indice}(indice=${iter.index})}" method="post">
                    <button class="btn btn-sm btn-outline-danger" type="submit" title="Quitar">
                      <i class="bi bi-trash"></i>
                    </button>
                  </form>
                </td>
              </tr>
              <tr th:if="${session.carritoMovimiento == null || #lists.isEmpty(session.carritoMovimiento)}">
                <td colspan="4" class="text-center text-secondary py-4">No hay productos agregados todavía.</td>
              </tr>
              </tbody>
            </table>
          </div>

          <div class="small text-secondary">
            Tip: si el producto no existe, crea primero el producto en <b>Productos</b>.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<th:block th:replace="fragments/scripts :: scripts"></th:block>
</body>
</html>
